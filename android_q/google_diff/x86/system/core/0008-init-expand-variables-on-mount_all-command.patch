From 05a9f20e519f6c0b054c52e9212e1c966756c7f9 Mon Sep 17 00:00:00 2001
From: Chih-Wei Huang <cwhuang@linux.org.tw>
Date: Mon, 23 Nov 2015 17:57:37 +0800
Subject: [PATCH 08/24] init: expand variables on mount_all command

This allows mount_all to handle fstab.${ro.hardware} instead
of hardcoding the file name.

Change-Id: Ia7fb4e5a84dd50a46afdd4239b9b06204f449cfe
---
 init/builtins.cpp | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/init/builtins.cpp b/init/builtins.cpp
index 200bfff7d..d89e8e8da 100644
--- a/init/builtins.cpp
+++ b/init/builtins.cpp
@@ -660,11 +660,16 @@ static Result<void> do_mount_all(const BuiltinArguments& args) {
         }
     }
 
+    auto filename_val = ExpandProps(fstab_file);
+    if (!filename_val) {
+        return Error() << "mount_all: cannot expand '" << fstab_file << "': " << filename_val.error();
+    }
+
     std::string prop_name = "ro.boottime.init.mount_all."s + prop_post_fix;
     android::base::Timer t;
 
     Fstab fstab;
-    if (!ReadFstabFromFile(fstab_file, &fstab)) {
+    if (!ReadFstabFromFile(*filename_val, &fstab)) {
         return Error() << "Could not read fstab";
     }
 
@@ -691,8 +696,13 @@ static Result<void> do_mount_all(const BuiltinArguments& args) {
 
 /* umount_all <fstab> */
 static Result<void> do_umount_all(const BuiltinArguments& args) {
+    auto filename_val = ExpandProps(args[1]);
+    if (!filename_val) {
+        return Error() << "umount_all: cannot expand '" << args[1] << "': " << filename_val.error();
+    }
+
     Fstab fstab;
-    if (!ReadFstabFromFile(args[1], &fstab)) {
+    if (!ReadFstabFromFile(*filename_val, &fstab)) {
         return Error() << "Could not read fstab";
     }
 
-- 
2.25.1

