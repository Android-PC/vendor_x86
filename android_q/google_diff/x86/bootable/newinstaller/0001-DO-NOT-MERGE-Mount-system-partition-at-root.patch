From 731a557ce3f1a50e8b8db38d602ba484d16b3a3f Mon Sep 17 00:00:00 2001
From: Michael Goffioul <michael.goffioul@lincor.com>
Date: Sun, 13 Oct 2019 12:55:12 -0400
Subject: [PATCH] DO NOT MERGE: Mount system partition at root.

---
 initrd/init | 53 +++++++++++++++++++++++++----------------------------
 1 file changed, 25 insertions(+), 28 deletions(-)

diff --git a/initrd/init b/initrd/init
index 7b20c9d..4f95010 100755
--- a/initrd/init
+++ b/initrd/init
@@ -98,18 +98,14 @@ check_root()
 		mount -o loop /iso/$iso /mnt/iso
 		SRC=iso
 	fi
-	if [ -e /mnt/$SRC/$RAMDISK ]; then
-		zcat /mnt/$SRC/$RAMDISK | cpio -id > /dev/null
-	elif [ -b /dev/$RAMDISK ]; then
-		zcat /dev/$RAMDISK | cpio -id > /dev/null
-	else
+	if [ ! -e /mnt/$SRC/$RAMDISK ]; then
 		return 1
 	fi
 	if [ -e /mnt/$SRC/system.sfs ]; then
-		mount -o loop,noatime /mnt/$SRC/system.sfs system
-		if [ -e system/system.img ]; then
-			mount --move system /sfs
-			mount -o loop,noatime /sfs/system.img system
+		mount -o loop,noatime /mnt/$SRC/system.sfs android
+		if [ -e android/system.img ]; then
+			mount --move android /sfs
+			mount -o loop,noatime /sfs/system.img android
 		fi
 	elif [ -e /mnt/$SRC/system.img ]; then
 		remount_rw
@@ -120,10 +116,8 @@ check_root()
 	elif [ -e /mnt/build.prop ]; then
 		mount --bind /mnt system
 	else
-		rm -rf *
 		return 1
 	fi
-	mkdir -p mnt
 	echo " found at $1"
 	rm /sbin/mke2fs
 	hash -r
@@ -138,13 +132,13 @@ remount_rw()
 
 debug_shell()
 {
-	if [ -x system/bin/sh ]; then
-		echo Running MirBSD Korn Shell...
-		USER="($1)" system/bin/sh -l 2>&1
-	else
+	#if [ -x system/bin/sh ]; then
+	#	echo Running MirBSD Korn Shell...
+	#	USER="($1)" system/bin/sh -l 2>&1
+	#else
 		echo Running busybox ash...
-		sh 2>&1
-	fi
+		busybox sh 2>&1
+	#fi
 }
 
 echo -n Detecting Android-x86...
@@ -162,8 +156,7 @@ for c in `cat /proc/cmdline`; do
 	esac
 done
 
-mount -t tmpfs tmpfs /android
-cd /android
+cd /
 while :; do
 	for device in ${ROOT:-/dev/[hmnsv][dmrv][0-9a-z]*}; do
 		check_root $device && break 2
@@ -172,6 +165,7 @@ while :; do
 	sleep 1
 	echo -n .
 done
+cd /android
 
 ln -s mnt/$SRC /src
 ln -s android/system /
@@ -181,15 +175,15 @@ if [ -n "$INSTALL" ]; then
 	zcat /src/install.img | ( cd /; cpio -iud > /dev/null )
 fi
 
-if [ -x system/bin/ln -a \( -n "$DEBUG" -o -n "$BUSYBOX" \) ]; then
-	mv -f /bin /lib .
-	sed -i 's|\( PATH.*\)|\1:/bin|' init.environ.rc
-	rm /sbin/modprobe
-	busybox mv /sbin/* sbin
-	rmdir /sbin
-	ln -s android/bin android/lib android/sbin /
-	hash -r
-fi
+# if [ -x system/bin/ln -a \( -n "$DEBUG" -o -n "$BUSYBOX" \) ]; then
+# 	mv -f /bin /lib .
+# 	sed -i 's|\( PATH.*\)|\1:/bin|' init.environ.rc
+# 	rm /sbin/modprobe
+# 	busybox mv /sbin/* sbin
+# 	rmdir /sbin
+# 	ln -s android/bin android/lib android/sbin /
+# 	hash -r
+# fi
 
 # load scripts
 for s in `ls /scripts/* /src/scripts/*`; do
@@ -237,6 +231,9 @@ fi
 # since it conflicts with Android's init
 echo > /proc/sys/kernel/hotplug
 
+# Use correct modprobe location
+echo /bin/modprobe > /proc/sys/kernel/modprobe
+
 export ANDROID_ROOT=/system
 
 exec ${SWITCH:-switch_root} /android /init
-- 
2.21.0

