From 72e3591ce28f82fad56735802520852802232f51 Mon Sep 17 00:00:00 2001
From: Uldiniad <olivercscott@gmail.com>
Date: Mon, 8 Oct 2018 00:20:49 -0400
Subject: [PATCH 2/2] dex2oat: disable multithreading for WSL

* In its current state, WSL does not support dex2oat multithreading

Change-Id: I325d7f3428d74cb7a4845ef9cf339115a36ce832
---
 core/dex_preopt_libart.mk | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/core/dex_preopt_libart.mk b/core/dex_preopt_libart.mk
index 9c4d55de7..45ce37b08 100644
--- a/core/dex_preopt_libart.mk
+++ b/core/dex_preopt_libart.mk
@@ -170,6 +170,9 @@ my_2nd_arch_prefix :=
 # In the case where LOCAL_ENFORCE_USES_LIBRARIES is true, PRIVATE_DEX2OAT_CLASS_LOADER_CONTEXT
 # contains the normalized path list of the libraries. This makes it easier to conditionally prepend
 # org.apache.http.legacy.boot based on the SDK level if required.
+ifeq ($(HOST_OS_IS_WSL),true)
+SINGLE_THREAD := "-j1"
+endif
 define dex2oat-one-file
 $(hide) rm -f $(2)
 $(hide) mkdir -p $(dir $(2))
@@ -184,6 +187,7 @@ source build/make/core/verify_uses_libraries.sh "$(1)" && \
 source build/make/core/construct_context.sh "$(PRIVATE_CONDITIONAL_USES_LIBRARIES_HOST)" "$(PRIVATE_CONDITIONAL_USES_LIBRARIES_TARGET)" && \
 ,) \
 ANDROID_LOG_TAGS="*:e" $(DEX2OAT) \
+	$(SINGLE_THREAD) \
 	--runtime-arg -Xms$(DEX2OAT_XMS) --runtime-arg -Xmx$(DEX2OAT_XMX) \
 	$${class_loader_context_arg} \
 	$${stored_class_loader_context_arg} \
-- 
2.17.1

